#!/bin/bash

# This script takes snapshots or revert snapshots of libvirt domains using ZFS.
#
# It can take two kinds of snapshots: crash-consistent snapshots and live snapshots.
#
# - Crash-consistent snapshots are taken when the VM is powered off or powered on.
#   They capture only the disk state at the time of the snapshot.
#   Especially, those items are NOT included in crash-consistent snapshots: TPM, NVRAM, domain definition (XML).
#
#   Taking crash-consistent snapshots makes use of ZFS filesystem snapshots of the underlying storage volumes
#
#   Restoring from crash-consistent snapshots involves destroying the domain, reverting the ZFS snapshots and
#   restarting the domain.
#
# - Live snapshots are taken while the VM is running and capture the entire state of the VM, including memory,
#   CPU state, TPM, NVRAM, and domain definition (XML).
#
#   Taking live snapshots makes use of libvirt's "save" functionality. The domain is paused, its state is saved
#   to disk, the ZFS snapshots of the underlying storage volumes are taken, and then the domain is resumed.
#
#   Restoring from live snapshots involves destroying the domain, reverting the ZFS snapshots, restoring the saved state,
#   and restarting the domain.
#

set -Eeuo pipefail

# Make sure the output of underlying tool won't be altered by locale settings
export LANG=C
export LC_ALL=C

# Load core library
script_dir="$(realpath "$(dirname "${BASH_SOURCE[0]}")/../")"
source "$script_dir/lib/zvirt/core.sh"

# Parse command line arguments and act accordingly
init_global_variables
if ! parse_args "$@"; then
  echo
  show_help >&2
  exit 1
fi

case "$action" in
  snapshot)
    preflight_checks "$action" "$snapshot_name" "${domains[@]}" || fatal "Pre-flight checks failed."
    take_snapshots || fatal "Failed to take snapshots."
    ;;
  revert)
    preflight_checks "$action" "$snapshot_name" "${domains[@]}" || fatal "Pre-flight checks failed."
    revert_snapshots || fatal "Failed to revert snapshots."
    ;;
  list)
    if [ ${#domains[@]} -eq 0 ]; then
      # Get all domains
      mapfile -t domains < <(virsh list --all --name | grep -v '^$')
    fi
    list_snapshots "${domains[@]}" || fatal "Failed to list snapshots."
    ;;
  *)
    fatal "Unknown action '$action'."
    ;;
esac

log_verbose "Operation '$action' completed successfully."
exit 0
